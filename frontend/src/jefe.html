<!doctype html><html><head>
<meta charset="utf-8"><title>Jefe - Planilla</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="assets/css/styles.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // Configuración global de Axios
  axios.defaults.baseURL = 'http://localhost/planilla_horas_toneladas/backend/src';
  axios.defaults.withCredentials = true; // permite enviar cookies/sesiones
</script>
</head><body>
<div class="container">
  <div class="header"><h2>JEFE</h2>
    <h2>Novedades de Nómina</h2>
    <div class="actions">
      <a href="adicionales_cali.html" class="btn">Adicionales</a><button id="btnSalir" class="btn secondary">Salir</button></div>
  </div>
  <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
    <label>Fecha Inicio: <input type="date" id="fechaInicio" style="padding: 8px;"></label>
    <label>Fecha Fin: <input type="date" id="fechaFin" style="padding: 8px;"></label>
    <button id="btnFiltrar" class="btn">Filtrar</button>
  </div>
  <table class="table" id="tablaJefe"><thead>
    <tr><th>Nombre</th><th>Unidad</th><th>Bono Transporte</th><th>Bono Alimentación</th><th>Recargo</th><th>HE Diurnas</th><th>HE Nocturnas</th><th>H Dom/Fest</th><th>HE Diurnas Dom/Fest</th><th>HE Nocturnas Dom/Fest</th><th>Ton</th><th>Ton Coteadas</th><th>Registros</th><th>Acción</th></tr>
  </thead><tbody></tbody></table>
</div>
<script>
document.getElementById('btnSalir').addEventListener('click', async ()=>{ 
  try {
    await axios.post('?path=auth/logout');
  } catch(e) {
    console.error('Error al cerrar sesión', e);
  } finally {
    location.href='index.html';
  }
});

// Inicializar fechas
function initializeDates() {
  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  
  document.getElementById('fechaInicio').valueAsDate = firstDay;
  document.getElementById('fechaFin').valueAsDate = lastDay;
}

async function load(){
  const fechaInicio = document.getElementById('fechaInicio').value;
  const fechaFin = document.getElementById('fechaFin').value;
  
  try{
    const res = await axios.get(`?path=registros/summary&fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`);
    const rows = res.data.data;
    const tbody = document.querySelector('#tablaJefe tbody');
    tbody.innerHTML='';
    
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.nombres} ${r.apellidos}</td>
        <td>${r.unidad_operativa}</td>
        <td>${parseFloat(r.bono_transporte || 0).toFixed(2)}</td>
        <td>${parseFloat(r.bono_alimentacion || 0).toFixed(2)}</td>
        <td>${parseFloat(r.recargo_nocturno || 0).toFixed(2)}</td>
        <td>${parseFloat(r.he_diurnas || 0).toFixed(2)}</td>
        <td>${parseFloat(r.he_nocturnas || 0).toFixed(2)}</td>
        <td>${parseFloat(r.he_dom_fest || 0).toFixed(2)}</td>
        <td>${parseFloat(r.he_diurnas_dom || 0).toFixed(2)}</td>
        <td>${parseFloat(r.he_nocturnas_dom || 0).toFixed(2)}</td>
        <td>${parseFloat(r.toneladas || 0).toFixed(2)}</td>
        <td>${parseFloat(r.ton_coteadas || 0).toFixed(2)}</td>
        <td>${r.registros_count}</td>
        <td><a class="btn" href="auxiliar.html?user_id=${r.id}">Ver/Editar</a></td>
      `;
      tbody.appendChild(tr);
    });
  }catch(e){ 
    console.error(e); 
    if(e.response?.status===401) location.href='index.html'; 
    else {
      const tbody = document.querySelector('#tablaJefe tbody');
      tbody.innerHTML = `<tr><td colspan="14" style="text-align:center; color:red;">Error al cargar datos. Intenta nuevamente.</td></tr>`;
    }
  }
}

// Event listeners
document.getElementById('btnFiltrar').addEventListener('click', load);

// Cargar al iniciar
initializeDates();
load();
</script>
</body></html>
