<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Auxiliar - Planilla</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // ‚úÖ Configuraci√≥n global de Axios
    axios.defaults.baseURL = 'http://localhost/planilla_horas_toneladas/backend/src';
    axios.defaults.withCredentials = true; // permite enviar cookies de sesi√≥n
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>AUXILIAR</h2>
      <h2>Reguistro Diario</h2>
      <div class="actions">
        <a href="registro_diario.html" class="btn">Registro Diario</a>
        <button id="btnSalir" class="btn secondary">Salir</button>
      </div>
    </div>

    <div id="userInfo" class="user-info"></div>

    <table class="table" id="tablaRegistros">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Entrada</th>
          <th>Salida</th>
          <th>Bono Transporte</th>
          <th>Bono Alimentaci√≥n</th>
          <th>Recargo Nocturno</th>
          <th>HE Diurnas</th>
          <th>HE Nocturnas</th>
          <th>H Dom/Fest (7h 20m)</th>
          <th>HE Diurnas Dom/Fest</th>
          <th>HE Nocturnas Dom/Fest</th>
          <th>Toneladas</th>
          <th>Ton Coteadas</th>
          <th>Firma</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function loadUser() {
      try {
        const res = await axios.get(
          'http://localhost/planilla_horas_toneladas/backend/src/index.php?path=auth/me',
          { withCredentials: true }
        );
        const user = res.data.user;
        const userInfoDiv = document.getElementById('userInfo');
        userInfoDiv.innerHTML = `
          <p><strong>Bienvenido:</strong> ${user.nombres} ${user.apellidos}</p>
          <p><strong>Unidad Operativa:</strong> ${user.unidad_operativa}</p>
        `;
      } catch (e) {
        console.error('Error al obtener el usuario', e);
        if (e.response?.status === 401) {
          location.href = 'index.html';
        } else {
          const userInfoDiv = document.getElementById('userInfo');
          userInfoDiv.innerHTML = `<p style="color:red;">‚ö†Ô∏è Error al cargar datos del usuario. Intenta recargar la p√°gina.</p>`;
        }
      }
    }

    async function loadRegistros() {
      try {
        const res = await axios.get('?path=registros/user', { withCredentials: true });
        const rows = res.data?.data || [];
        const tbody = document.querySelector('#tablaRegistros tbody');
        tbody.innerHTML = '';

        if (rows.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="14" style="text-align:center; color:gray; font-style:italic;">
                No hay registros disponibles para esta quincena.
              </td>
            </tr>`;
          return;
        }

        rows.forEach(r => {
          const tr = document.createElement('tr');

          // Detectar domingo
          const fecha = new Date(r.fecha);
          const isSunday = fecha.getDay() === 0;

          // Si quieres manejar festivos manualmente:
          const festivos = []; 
          const isHoliday = festivos.includes(r.fecha);

          // --- Valores originales ---
          let he_diurnas = r.he_diurnas || 0;
          let he_nocturnas = r.he_nocturnas || 0;
          let he_dom_fest = r.he_dom_fest || 0;
          let he_diurnas_dom = r.he_diurnas_dom || 0;
          let he_nocturnas_dom = r.he_nocturnas_dom || 0;

          // ---------------------------------------------------
          // üî• L√ìGICA FRONTEND PARA EVITAR DUPLICACI√ìN
          // ---------------------------------------------------

          if (isSunday || isHoliday) {
            // Domingo / Festivo -> BORRAR horas normales
            he_diurnas = 0;
            he_nocturnas = 0;
          } else {
            // D√≠a normal -> BORRAR horas dominicales
            he_dom_fest = 0;
            he_diurnas_dom = 0;
            he_nocturnas_dom = 0;
          }

          if (isSunday) {
            tr.classList.add('dia-festivo');
          }

          tr.innerHTML = `
            <td>${r.fecha}</td>
            <td>${r.hora_entrada || ''}</td>
            <td>${r.hora_salida || ''}</td>
            <td>${r.bono_transporte || 0}</td>
            <td>${r.bono_alimentacion || 0}</td>
            <td>${r.recargo_nocturno || 0}</td>

            <td>${he_diurnas}</td>
            <td>${he_nocturnas}</td>
            <td>${he_dom_fest}</td>
            <td>${he_diurnas_dom}</td>
            <td>${he_nocturnas_dom}</td>

            <td>${r.toneladas || 0}</td>
            <td>${r.ton_coteadas || 0}</td>
            <td>${r.firma ? 'S√≠' : ''}</td>
          `;

          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        const tbody = document.querySelector('#tablaRegistros tbody');
        if (e.response?.status === 401) {
          location.href = 'index.html';
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="14" style="text-align:center; color:red;">
                Error al cargar los registros: ${e.response?.data?.error || e.message}. Intenta recargar.
              </td>
            </tr>`;
        }
      }
    }

    document.getElementById('btnSalir').addEventListener('click', async () => {
      try {
        await axios.post('?path=auth/logout');
      } catch (e) {
        console.error('Error al cerrar sesi√≥n', e);
      } finally {
        location.href = 'index.html';
      }
    });

    loadUser();
    loadRegistros();
  </script>
</body>
</html>
